<!DOCTYPE html><html lang="zh-cn"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Jarvis异步任务平台介绍 | ShareCore</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.1.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.2/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/2.2.3/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Jarvis异步任务平台介绍</h1><a id="logo" href="/.">ShareCore</a><p class="description">Justin.H</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首頁</i></a><a href="/archives/"><i class="fa fa-archive"> 所有文章</i></a><a href="http://weibo.com/justinhuang"><i class="fa fa-user"> 關於</i></a><a href="/atom.xml"><i class="fa fa-rss"> 訂閱</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Jarvis异步任务平台介绍</h1><div class="post-meta">Apr 2, 2018<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="post-content"><h1 id="概述">概述</h1><p>异步任务是日常开发过程中经常要面对的开发场景，比如系统间数据同步、批量数据加工或验证类资源消耗性任务、大批量数据Excel\CSV文件生成、定时消息通知等等，对于这些场景开发，有很多方式可以实现，如数据库的定时Job、Linux Crontab、Quartz等，但这些方式只是实现了任务的定时触发，对于任务的管理监控、资源调度、复用和可扩展等功能，均不能很好的满足。</p>
<p>Jarvis异步任务平台(Jarvis-Task)是一个基于分布式的定时任务调度方案，它基于主从架构，致力于解决以下问题：</p>
<ul>
<li>循环任务与用户提交形任务定时调度</li>
<li>任务执行资源的弹性可扩展</li>
<li>可扩展与可并行执行的任务执行框架</li>
<li>Job配置管理与执行监控</li>
<li>Built-in常用任务</li>
</ul>
<h1 id="简介">简介</h1><p>1、基本概念：</p>
<ul>
<li><p><strong>Job：</strong>Job是指一个完整的业务逻辑处理作业，一个Job由一个或多个不同的执行单元(Task)组成。Jarvis-Task平台负责Job级别的分布式调度，每个Job的Task之间的调度为单机进程内进行，可进行串行和并行调度。</p>
</li>
<li><p><strong>JobInstance：</strong>JobInstance是指Job执行的每一个执行实例，可以理解为Job执行的输入参数，一个Job可以有多个JobInstance，并可以在不同的Job节点中执行。JobInstance分为单次执行实例和循环执行实例，单次执行实例适用于用户提交形的任务，循环执行实例适合于常见的定时循环任务。</p>
</li>
<li><p><strong>分片</strong>：一个分片是指一个将一个执行实例按一定的维度分成多个更小的执行单元(Sharding)，每个Sharding可以在调度到不同的执行节点上，达到了在多个节点上并行执行一个执行实例的效果，提升任务执行的效率。如一个JobInstance需要处理1000笔数据，有两个执行节点，采取分片的方式，可以分成两个分片，并行执行，每个节点上执行500笔。</p>
</li>
<li><p><strong>节点：</strong>即一个执行单元，每个执行单元可以承载多个Job的执行。</p>
</li>
</ul>
<p><img src="/images/jarvis-task/1.png" alt="概念说明"></p>
<p>2、架构说明</p>
<p>Jarvis-Task采用主从架构(Master-Slave)，Master主要负责Job的配置与分发、JobInstance的收集与分发，Job执行结果的收集与监控、Job分片的分发管理等。Slave为实际的Job执行节点，它主要负责Job的定时触发、JobInstance探测与执行、执行结果上报等。<strong>Master与Slave均采用多节点设计，两者之间基于Jarvis RPC进行通信与服务发现管理。</strong></p>
<p>如下图所示：<br><img src="/images/jarvis-task/2.png" alt="架构图"></p>
<p>3、分布式调度</p>
<p>Jarvis-Task的Job执行不由Master统一触发，而由各个Job执行节点(Slave)按配置定时触发，以降低了Job调度的复杂性，提高了调度的可靠性，并同时保证了Master的无状态，使Master也可以灵活扩容，保证高可用。<strong>Job调度的最小单位是一个JobInstance分片或一个JobInstance</strong>，各个Job执行节点采取竞争的方式从Matser获取响应的JobInstance或分片。</p>
<p>4、Job Task调度:</p>
<p>一个Task是Job在一个Job节点上最小的逻辑执行单元，一个Job可以按业务需要拆分为多个Task，按照一定的要求组合成一个完整的执行过程。通过配置，Task之间可以串行或并行进行调度，并提供了前置任务检查的配置，即可以达到多个并行的Task按照一定的前置执行要求进行调度。比如某个Job有A、B、C、D四个个不同的Task，其中A、B、C可以并行执行，但是D需要等待C执行完成才能执行，通过配置任务的前置任务即可满足调度要求。</p>
<p>5、分片管理:</p>
<p>Javis-Task并不是提供自动的Job数据分片功能，而是按照当前配置以及当前Job的活动执行节点个数，均衡地生成分片参数，<strong>在Task的业务逻辑开发过程中，可以获取到当前分配的分片参数，在Task的逻辑里自行实现分片参数与真实业务数据间的关系。</strong>举例来说：一个Task需要从数据库的某一个表里读取数据进行处理，通过配置，按id进行将数据分为3个分片，分别为0-10w、10w-20w、大于20w，当任务执行是，平台会按照当前可用的Job节点数将3个分片以分片参数的方式分配到相应的节点上，每个节点按照分配到的相应分片参数，获取对应区间范围的参数进行处理，简单来说，Task里获取数据的语句可以用以下方式表示：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">table</span> </span><br><span class="line"><span class="keyword">where</span> id&gt;&#123;minShardingValue&#125; </span><br><span class="line"><span class="keyword">and</span> (id&lt;&#123;maxShardingValue&#125; <span class="keyword">or</span> &#123;maxShardingValue&#125; <span class="keyword">is</span> <span class="literal">null</span>)</span><br><span class="line"><span class="comment">--其中minShardingValue、maxShardingValue为平台分配的分片参数。</span></span></span><br></pre></td></tr></table></figure>
<h1 id="开发入门">开发入门</h1><p>1、引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">groupId</span>&gt;</span>com.tencent.oa.fm<span class="tag">&lt;/<span class="title">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">artifactId</span>&gt;</span>jarvis-task-slave<span class="tag">&lt;/<span class="title">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="title">version</span>&gt;</span>            </span><br><span class="line"><span class="tag">&lt;/<span class="title">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>2、开发一个简单Task</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoTask</span> <span class="keyword">extends</span> <span class="title">AbstractTaskBase</span> </span>&#123;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">actualExecute</span><span class="params">(TaskContext taskContext)</span> <span class="keyword">throws</span> JobInvokeException </span>&#123;</span><br><span class="line">    	<span class="comment">//从当前执行实例里获取执行参数</span></span><br><span class="line">    	String batchId=taskContext.getJobInstanceParamResolver().resolve(<span class="string">"batchId"</span>);</span><br><span class="line">        <span class="keyword">if</span>(taskContext.getSharding()!=<span class="keyword">null</span>)&#123;</span><br><span class="line">        	<span class="comment">//按分片参数处理数据</span></span><br><span class="line">        	<span class="keyword">int</span> min=taskContext.getSharding().getBeginShardingValue();</span><br><span class="line">            <span class="keyword">int</span> max=taskContext.getSharding().getBeginShardingValue();</span><br><span class="line">        	List&lt;Data&gt; data=repo.qeury(<span class="string">"select * from table where batchId=? and id&gt;? and id&lt;?"</span>,batchId,min,max);</span><br><span class="line">        	Object result= processData(data);</span><br><span class="line">        	<span class="comment">//将结果写回上下文，下一步Task可以获取到</span></span><br><span class="line">          taskContext.put(<span class="string">"result"</span>,result);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        	List&lt;Data&gt; data=repo.qeury(<span class="string">"select * from table where batchId=?"</span>,batchId);</span><br><span class="line">          Object result= processData(data);</span><br><span class="line">          taskContext.put(<span class="string">"result"</span>,result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3、配置JobTask</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;Job JobName="DemoJob"&gt;</span><br><span class="line">  &lt;Task TaskName="ProcessData" Description="数据加工处理"  ExecuteType="Sync" </span><br><span class="line">    TaskType="com.demo.DemoTask"</span><br><span class="line">  &lt;/Task&gt;</span><br><span class="line">&lt;/Job&gt;</span><br></pre></td></tr></table></figure>
<p>一个复杂一点JobTask配置例子：<br>Task2在Task1执行完后串行执行、 Task3、Task4和Task1可以并行执行，但是Task3需要Task1执行成功后才可以执行</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;Job JobName="DemoJob"&gt;</span><br><span class="line">  &lt;Task TaskName="Task1" Description="数据处理1"  ExecuteType="Asyn" TaskType="com.demo.DemoTask1"</span><br><span class="line">    &lt;Task TaskName="Task2" Description="数据处理2" TaskType="com.demo.DemoTask1"/&gt;</span><br><span class="line">  &lt;/Task&gt;</span><br><span class="line">  &lt;Task TaskName="Task3" Description="数据处理3"  ExecuteType="Asyn" TaskType="com.demo.DemoTask3" PreConstraint="ProcessData1"/&gt;</span><br><span class="line">  &lt;Task TaskName="Task4" Description="数据处理4"  ExecuteType="Asyn" TaskType="com.demo.DemoTask3"/&gt;</span><br><span class="line">&lt;/Job&gt;</span><br></pre></td></tr></table></figure>
<p>4、在管理端配置Job和分配节点</p>
<p><img src="/images/jarvis-task/3.png" alt="配置Job"></p>
<p><img src="/images/jarvis-task/4.png" alt="配置Job"></p>
<p>5、Built-in常用任务介绍</p>
<p>为了提供快速的任务开发以及标准功能复用，平台内置实现了多种Task,如数据库调用、HTTP调用、Jarvis RPC调用、消息发送、Excel\CSV文件生成等常用功能，使得这些任务代码不需要再重新开发，只需要进行配置即可完成相应的业务功能，显著提高了开发效率。需要特别告知的是，<strong>Jarvis-Task还提供了一个较为完整用于数据处理的ETL任务库，</strong>封装了常见的ETL功能，关于这个ETL库的介绍，将在后续详细说明。</p>
<h1 id="将来规划">将来规划</h1><p>1、Job隔离：由于同一个Slave节点上需要执行多个Job，意味着不同Job的代码需要部署在一个节点上，Job间代码依赖的差异，容易导致冲突，从而需要一套代码隔离运行的机制。将来可以考虑采用Docker或模块化加载的方式来实现隔离，目前建议按相应的业务模块部署节点，即尽量将同一个业务模块的Job部署为一个节点，减少依赖差异带来的问题。</p>
<p>2、执行失败转移：目前的设计，当一个JobInstance或一个分片执行失败后，考虑到数据一致性的问题，并不会自动将该JobInstance置位可继续执行。将来需要有一定的机制对执行失败进行分级处理，对非影响业务数据一致性的错误，要能实现自动的错误转移。</p>
<p>3、对于用户提交形的JobInstance，考虑实现自动触发执行，而非目前轮询的方式，以减少由轮询带来的执行时间消耗，实现类似消息队列的方式。</p>
<p>3、完善日志分析功能，依赖于Jarvis的日志分析平台建设进度，更透明化地将Job日志进行分析，发现Job执行过程中的问题。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://sharecore.net/2018/04/02/Jarvis异步任务平台介绍/" data-id="cjfkvakp600344nvjzbfihmow" class="article-share-link">分享至</a><div class="tags"></div><div class="post-nav"><a href="/2017/05/07/GC知识笔记/" class="next">JVM GC知识笔记</a></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://sharecore.net"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分類</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 標籤</i></div><div class="tagcloud"><a href="/tags/基础知识/" style="font-size: 15px;">基础知识</a><a href="/tags/常识/" style="font-size: 15px;">常识</a><a href="/tags/技术常识/" style="font-size: 15px;">技术常识</a><a href="/tags/架构/" style="font-size: 15px;">架构</a><a href="/tags/算法/" style="font-size: 15px;">算法</a><a href="/tags/历史/" style="font-size: 15px;">历史</a><a href="/tags/学习/" style="font-size: 15px;">学习</a><a href="/tags/服务化/" style="font-size: 15px;">服务化</a><a href="/tags/技术/" style="font-size: 15px;">技术</a><a href="/tags/模式匹配/" style="font-size: 15px;">模式匹配</a><a href="/tags/春秋/" style="font-size: 15px;">春秋</a><a href="/tags/Golang/" style="font-size: 15px;">Golang</a><a href="/tags/读书/" style="font-size: 15px;">读书</a><a href="/tags/测试/" style="font-size: 15px;">测试</a><a href="/tags/复杂性/" style="font-size: 15px;">复杂性</a><a href="/tags/Linux/" style="font-size: 15px;">Linux</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/04/02/Jarvis异步任务平台介绍/">Jarvis异步任务平台介绍</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/07/GC知识笔记/">JVM GC知识笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/09/RPC服务追踪的原理与实践/">RPC服务追踪的原理与实践</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/01/分布式锁进阶1-基础/">分布式锁进阶1-基础</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/16/懷才不遇/">懷才不遇？</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/27/讀張五常談思考方法/">讀張五常談思考方法</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/22/超越辯論的價值/">超越辯論的價值</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/20/電子閱讀的問題反思/">電子閱讀的問題反思</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/20/讀點王陽明/">讀點王陽明</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/17/文字之殤/">文字之殤</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友站連結</i></div><ul></ul><a href="http://weibo.com/justinhuang" title="微博" target="_blank">微博</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">ShareCore.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-37230829-1','auto');ga('send','pageview');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>